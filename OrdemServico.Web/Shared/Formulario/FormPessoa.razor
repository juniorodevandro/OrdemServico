@page "/FormPessoa"

@inject IDialogService DialogService

<MudDialog>
    <DialogContent>
        <MudGrid>
            <MudItem md="5" sm="4" xs="12">
                <CustomTextField Label="Nome" @bind-Value="Pessoa.Nome" Required="true" />
            </MudItem>
            <MudItem md="3" sm="4" xs="12">
                <CustomTextField Label="CPF/CNPJ" @bind-Value="Pessoa.CpfCnpj" ReadOnly="@(IsEditMode)" Required="@(!IsEditMode)"  Mask="Pessoa.CpfCnpj.ToCpfCnpjMask()" />
            </MudItem>
            <MudItem md="2" sm="2" xs="6">
                <CustomTextField Label="Tipo" @bind-Value="Pessoa.TipoNome" ReadOnly="@(IsEditMode)" Required="@(!IsEditMode)" />
            </MudItem>
            <MudItem md="2" sm="2" xs="6">
                <CustomIntField Label="Código" @bind-Value="Pessoa.Codigo" ReadOnly="true" Class="text-right" />
            </MudItem>
            <MudItem md="12" sm="12" xs="12">
                <CustomTextField Label="Contato" @bind-Value="Pessoa.Contato" Mask="Pessoa.CpfCnpj.ToPhoneMask()" />
            </MudItem>
        </MudGrid>
    </DialogContent>

    <DialogActions>
        <MudButton Color="Color.Error" OnClick="Cancel">Fechar</MudButton>
        <MudButton Color="Color.Success" OnClick="Save">Ok</MudButton>
    </DialogActions>

</MudDialog>


@code {
    [Inject]
    public IPessoa? PessoaService { get; set; }

    @inject ISnackbar Snackbar

    [Parameter]
    public PessoaGetDTO Pessoa { get; set; } = new PessoaGetDTO();

    [Parameter]
    public int PessoaId { get; set; }

    [Parameter]
    public bool IsEditMode { get; set; } = false;

    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; } = new();

    private PessoaGetDTO _pessoaForm = new PessoaGetDTO();

    private async void Add()
    {
        var pessoaPostDTO = new PessoaPostDTO()
        {
            CpfCnpj = Pessoa.CpfCnpj,
            Nome = Pessoa.Nome,
            Contato = Pessoa.Contato,
            TipoNome = Pessoa.TipoNome
        };

     
        try
        {
            var response = await PessoaService.AdicionarPessoa(pessoaPostDTO);

            if (response != null)
            {
                MudDialog.Close(DialogResult.Ok(true));
            }
        }
        catch (Exception e)
        {
            Snackbar.Add(e.Message, Severity.Error);
            throw;
        }
    }

    private async void Edit()
    {

    }

    private async void Save()
    {
        if (!IsEditMode) 
            Add();
        else 
            Edit();       
    }

    private void Cancel() => MudDialog.Cancel();
    
}